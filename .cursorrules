# Ghost Dashboard - Cursor Rules

## Scope de estas reglas
Solo gu√≠an estructura, est√°ndares, y tareas asistidas por Cursor. No decide UX ni l√≥gica de negocio. Aplica a:
- Frontend (Yew/WASM)
- Backend (Axum gateway/proxy) 
- CI local b√°sica

## Proyecto
Dashboard financiero en Rust + Yew que consume la inBestia API v√≠a backend proxy seguro.

## Estructura del Proyecto

### Workspace Rust
```
ghost/
‚îú‚îÄ .env.example            # Plantilla de variables (subir a git)
‚îú‚îÄ .env                    # Variables reales (NO subir a git)
‚îú‚îÄ .gitignore              # Excluir .env, target/, etc.
‚îú‚îÄ Cargo.toml              # Workspace con resolver "2"
‚îú‚îÄ Trunk.toml              # Proxy config para desarrollo
‚îú‚îÄ README.md               # Documentaci√≥n principal
‚îú‚îÄ PROGRESS.md             # Seguimiento del proyecto
‚îú‚îÄ docs/                   # Documentaci√≥n detallada
‚îú‚îÄ backend/                # Crate Axum (proxy/API)
‚îî‚îÄ frontend/               # Crate Yew (WASM/SPA)
```

### .gitignore
```
/target
/.env
/frontend/dist
**/*.rs.bk
.DS_Store
```

### .env.example
```
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/ghost_dev
INBESTIA_API_URL=http://localhost:8080
INBESTIA_API_KEY=CHANGEME
BIND_ADDR=127.0.0.1:8085
CORS_ALLOWED_ORIGINS=http://127.0.0.1:3001
```

### Trunk.toml
```toml
[[proxy]]
backend = "http://127.0.0.1:8085"
rewrite = "/api/"
```

### Backend (Axum)
```
backend/
‚îú‚îÄ Cargo.toml              # Dependencias: axum, tokio, reqwest, dotenvy, etc.
‚îî‚îÄ src/
   ‚îú‚îÄ main.rs              # Gateway principal con proxy
   ‚îú‚îÄ handlers/            # Manejadores de rutas (futuro)
   ‚îú‚îÄ middleware/          # CORS, auth, logging (futuro)
   ‚îî‚îÄ config/              # Configuraci√≥n (futuro)
```

### Frontend (Yew)
```
frontend/
‚îú‚îÄ Cargo.toml              # Dependencias: yew, yew-router, gloo-*, serde
‚îú‚îÄ index.html              # HTML base con Bulma CSS + CSP
‚îî‚îÄ src/
   ‚îú‚îÄ main.rs              # Entry point Yew
   ‚îú‚îÄ app.rs               # Componente ra√≠z
   ‚îú‚îÄ components/          # UI reutilizable
   ‚îÇ  ‚îú‚îÄ mod.rs
   ‚îÇ  ‚îú‚îÄ info_card.rs
   ‚îÇ  ‚îî‚îÄ common/           # Componentes comunes
   ‚îú‚îÄ services/            # HTTP, API calls
   ‚îÇ  ‚îú‚îÄ mod.rs
   ‚îÇ  ‚îî‚îÄ api.rs
   ‚îú‚îÄ domain/              # DTOs, tipos, mappers
   ‚îÇ  ‚îú‚îÄ mod.rs
   ‚îÇ  ‚îú‚îÄ types.rs
   ‚îÇ  ‚îî‚îÄ mappers.rs
   ‚îú‚îÄ stores/              # Estado global (yewdux/context)
   ‚îÇ  ‚îú‚îÄ mod.rs
   ‚îÇ  ‚îî‚îÄ portfolio.rs
   ‚îú‚îÄ routes/              # P√°ginas/vistas
   ‚îÇ  ‚îú‚îÄ mod.rs
   ‚îÇ  ‚îú‚îÄ dashboard.rs
   ‚îÇ  ‚îî‚îÄ asset.rs
   ‚îî‚îÄ utils/               # Helpers, errores
      ‚îú‚îÄ mod.rs
      ‚îú‚îÄ format.rs
      ‚îî‚îÄ errors.rs
```

### Index HTML (CSP + Bulma)
```html
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Ghost Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; connect-src 'self' http://127.0.0.1:8081; style-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; script-src 'self'; img-src 'self' data:">
</head>
<body>
  <div id="root"></div>
  <link data-trunk rel="rust" />
</body>
</html>
```

## Reglas de Desarrollo

### Rust
- Usar `edition = "2021"`
- Preferir `anyhow` para errores en backend
- Usar `thiserror` para errores en frontend
- Seguir convenciones de naming (snake_case)
- Documentar funciones p√∫blicas con `///`

### Backend (Axum)
- Usar `axum` con features: `["macros", "json"]`
- Implementar proxy para todas las rutas `/api/*`
- Inyectar `Authorization: Bearer $API_KEY` en rutas autenticadas
- Usar `CorsLayer::permissive()` para desarrollo
- Usar `TraceLayer` para logging
- Manejar errores con `anyhow::Result`

### Frontend (Yew)
- Usar `yew` con feature `["csr"]`
- Preferir `function_component` sobre `struct_component`
- Usar `use_state` y `use_effect_with` para estado
- Llamadas HTTP con `gloo_net::http::Request`
- Usar `serde` para serializaci√≥n/deserializaci√≥n
- Manejar errores con `Result<T, String>`

### Estilos
- Usar Bulma CSS desde CDN
- Preferir clases de Bulma sobre CSS custom
- Usar componentes de Bulma: `card`, `notification`, `progress`
- Responsive design con columnas de Bulma

### Seguridad
- **NUNCA exponer credenciales en el frontend (WASM)**
- **Prohibido INBESTIA_API_KEY en frontend y commits**
- Usar proxy backend para todas las llamadas autenticadas
- Variables sensibles solo en `.env` (backend)
- Frontend solo recibe URLs base, no claves
- **CORS: permissive solo en dev. En prod: CORS_ALLOWED_ORIGINS**
- **Passthrough p√∫blico solo: /, /health, /api/v1/info**

### Configuraci√≥n
- Backend: `BIND_ADDR=127.0.0.1:8085`
- Frontend: `trunk serve` en puerto 3001
- Proxy: Trunk reescribe `/api/` ‚Üí `http://127.0.0.1:8085`
- Variables: `DATABASE_URL`, `INBESTIA_API_URL`, `INBESTIA_API_KEY`, `CORS_ALLOWED_ORIGINS`
- **Prefijo gateway: /api/v1/* para versionado**

### Comandos de Desarrollo
```bash
# Terminal 1 - Backend
cd ghost/backend
cargo run

# Terminal 2 - Frontend  
cd ghost/frontend
trunk serve --open
```

### Est√°ndares de C√≥digo
- Usar `rustfmt` para formateo
- Usar `clippy` para linting
- Documentar funciones p√∫blicas
- Comentarios en espa√±ol para l√≥gica compleja
- Nombres descriptivos para variables y funciones

### Testing
- **Backend: tests de integraci√≥n en backend/tests/ para cada ruta del gateway con reqwest**
- **Frontend: tests de mappers/format helpers; no UI profunda**
- Tests unitarios en `#[cfg(test)]` modules
- Mock de APIs para tests del frontend
- **Server en puerto random para tests de integraci√≥n**

### Git
- Commits descriptivos en espa√±ol
- Branch por feature: `feature/nombre-funcionalidad`
- PRs con descripci√≥n clara
- **Nunca commitear `.env` con credenciales reales**
- **PR checklist: seguridad, logs, errores, tests**

### CI y Calidad
```bash
# Comandos obligatorios
cargo fmt --all -- --check
cargo clippy --workspace --all-targets -- -D warnings
cargo test --workspace
```

### Makefile (opcional)
```makefile
format:; cargo fmt --all
lint:; cargo clippy --workspace --all-targets -- -D warnings
test:; cargo test --workspace
run-backend:; cd backend && cargo run
run-frontend:; cd frontend && trunk serve --open
```

## Convenciones Espec√≠ficas

### Naming
- Archivos: `snake_case.rs`
- Funciones: `snake_case()`
- Structs: `PascalCase`
- Enums: `PascalCase`
- Constantes: `SCREAMING_SNAKE_CASE`

### Imports
- Agrupar por tipo: std, extern, local
- Orden alfab√©tico dentro de cada grupo
- Usar `use` espec√≠ficos, evitar `*`

### Error Handling
- Backend: `anyhow::Result<T>`
- Frontend: `Result<T, String>`
- **Logging con `tracing` y `TraceLayer` en backend**
- **No loggear claves ni secretos**
- **Est√°ndar de respuesta de error backend:**
```json
{
  "error": {
    "code": "UPSTREAM_TIMEOUT",
    "message": "Servicio no disponible",
    "trace_id": "abc123"
  }
}
```
- Notificaciones de error en UI

### Estado
- Local: `use_state` para componente
- Global: stores en `stores/` directory
- Persistencia: `gloo_storage` para localStorage

## Prompts de Tareas (para Cursor)

### 1) Nuevo componente Yew
Crea `frontend/src/components/{name}.rs` como `#[function_component]`.
- Genera Props con `#[derive(Properties, PartialEq, Clone)]`
- Solo render. Sin side effects
- Docstring con uso
- Actualiza `components/mod.rs`

### 2) Nuevo handler Axum proxied
En backend, crea handler para {METHOD} {PATH}.
- Forward a `{INBESTIA_API_URL}{PATH}`
- Timeout 5s, 2 retries con backoff 150/300 ms
- Mapea errores al contrato JSON est√°ndar
- A√±ade a router y test de integraci√≥n

### 3) Test integraci√≥n backend
Levanta app en puerto random con state dummy.
- Prueba GET `/api/v1/info` passthrough
- Asserta status, content-type y shape JSON
- Incluye `trace_id` en errores simulados

### 4) Llamada HTTP en frontend
En `frontend/src/services/api.rs` agrega funci√≥n `get_{name}()`:
- `gloo_net::http::Request` a `/api/v1/{path}`
- Retorna `Result<T, String>`
- Deserializa con `serde`
- A√±ade ejemplo de consumo en un componente

## Notas Importantes
- El frontend es WASM, no puede acceder directamente a APIs externas
- Todas las llamadas pasan por el proxy backend
- Las credenciales nunca llegan al navegador
- Usar Bulma para UI consistente y responsive
- Seguir principios de Rust: ownership, borrowing, lifetimes
- **Frontend habla solo con /api/*. Nada directo a proveedores**
- **Cache corto y m√©tricas pueden agregarse luego en middleware/**
- **Mantener README.md y PROGRESS.md al d√≠a**

## üö´ Reglas Cr√≠ticas de Desarrollo

### Backend (Axum)
- **NUNCA matar procesos en puerto 8080** - es la API de inBestia externa
- **SIEMPRE validar variables de entorno** al inicio de la aplicaci√≥n
- **SIEMPRE usar trace IDs** en todos los logs
- **SIEMPRE implementar headers de seguridad** autom√°ticamente
- **NUNCA usar CorsLayer::permissive()** en producci√≥n
- **SIEMPRE limitar tama√±o de requests** (m√°ximo 2MB)

### Frontend (Yew)
- **NUNCA exponer credenciales** en c√≥digo WASM
- **NUNCA hacer llamadas directas** a APIs externas (solo /api/*)
- **NUNCA usar HtmlSelectElement** (no existe en web_sys)
- **SIEMPRE manejar estados** Loading/Error/Success
- **SIEMPRE usar function_component** sobre struct_component
- **SIEMPRE mapear timeframes** usando TimeframeConfig.to_analysis_format()

### Estructura Modular Obligatoria
- **Backend**: config/, handlers/, middleware/ separados
- **Frontend**: components/, services/, domain/, stores/ organizados
- **Cada m√≥dulo** debe tener documentaci√≥n y ejemplos
- **Cada endpoint** debe tener health check y m√©tricas

### Observabilidad
- **SIEMPRE loggear duraci√≥n** de requests
- **SIEMPRE incluir trace_id** en respuestas de error
- **SIEMPRE implementar health checks** detallados
- **SIEMPRE monitorear m√©tricas** del sistema

### Seguridad
- **SIEMPRE validar entrada** de usuario
- **SIEMPRE sanitizar** datos antes de procesar
- **SIEMPRE usar HTTPS** en producci√≥n
- **NUNCA loggear** claves o secretos

## üìã Checklist Pre-Commit
- [ ] Variables de entorno validadas
- [ ] Headers de seguridad implementados
- [ ] Trace IDs en logs
- [ ] Manejo de errores consistente
- [ ] Tests pasando
- [ ] Sin warnings de compilaci√≥n
- [ ] Documentaci√≥n actualizada

## üîç Debugging
- **Backend**: Verificar /health, revisar logs con trace_id
- **Frontend**: Verificar compilaci√≥n, Network tab, estado
- **API**: Verificar conectividad, formato de timeframes
- **Config**: Comparar .env con .env.example
